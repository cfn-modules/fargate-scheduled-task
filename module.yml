---
# Copyright 2018 widdix GmbH
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
AWSTemplateFormatVersion: '2010-09-09'
Description: 'cfn-modules: Fargate scheduled task'
# cfn-modules:implements()
Parameters:
  VpcModule:
    Description: 'Stack name of vpc module.'
    Type: String
  ClusterModule:
    Description: 'Optional stack name of ecs-cluster module (if empty, an ECS cluster is created).'
    Type: String
    Default: ''
  AlertingModule:
    Description: 'Optional but recommended stack name of alerting module.'
    Type: String
    Default: ''
  FileSystemModule1:
    Description: 'Optional stack name of efs-file-system module.'
    Type: String
    Default: ''
  ClientSgModule1:
    Description: 'Optional stack name of client-sg module to mark traffic from Fargate task.'
    Type: String
    Default: ''
  ClientSgModule2:
    Description: 'Optional stack name of client-sg module to mark traffic from Fargate task.'
    Type: String
    Default: ''
  ClientSgModule3:
    Description: 'Optional stack name of client-sg module to mark traffic from Fargate task.'
    Type: String
    Default: ''
  ManagedPolicyArns:
    Description: 'Comma-delimited list of IAM managed policy ARNs to attach to the task''s IAM role.'
    Type: String
    Default: ''
  AppImage:
    Description: 'The Docker image to use for the app container. You can use images in the Docker Hub registry or specify other repositories (repository-url/image:tag). If the repository is private, set AppImageSecretModule as well!'
    Type: String
    Default: 'widdix/hello:v1'
  AppImageSecretModule:
    Description: 'Optional stack name of secret module which contains the repository credentials for private registry authentication.'
    Type: String
    Default: ''
  AppEntryPoint:
    Description: 'Optional entry point for app container.'
    Type: CommaDelimitedList
    Default: ''
  AppCommand:
    Description: 'Optional command for app container.'
    Type: CommaDelimitedList
    Default: ''
  AppEnvironment1Key:
    Description: 'Optional environment variable 1 key for app container.'
    Type: String
    Default: ''
  AppEnvironment1Value:
    Description: 'Optional environment variable 1 value for app container.'
    Type: String
    Default: ''
  AppEnvironment1SecretModule:
    Description: 'Optional environment variable 1 stack name of secret module for app container (if AppEnvironment1Key is set, set either AppEnvironment1Value or AppEnvironment1SecretModule).'
    Type: String
    Default: ''
  AppEnvironment2Key:
    Description: 'Optional environment variable 2 key for app container.'
    Type: String
    Default: ''
  AppEnvironment2Value:
    Description: 'Optional environment variable 2 value for app container.'
    Type: String
    Default: ''
  AppEnvironment2SecretModule:
    Description: 'Optional environment variable 2 stack name of secret module for app container (if AppEnvironment2Key is set, set either AppEnvironment2Value or AppEnvironment2SecretModule).'
    Type: String
    Default: ''
  AppEnvironment3Key:
    Description: 'Optional environment variable 3 key for app container.'
    Type: String
    Default: ''
  AppEnvironment3Value:
    Description: 'Optional environment variable 3 value for app container.'
    Type: String
    Default: ''
  AppEnvironment3SecretModule:
    Description: 'Optional environment variable 3 stack name of secret module for app container (if AppEnvironment3Key is set, set either AppEnvironment3Value or AppEnvironment3SecretModule).'
    Type: String
    Default: ''
  AppEnvironment4Key:
    Description: 'Optional environment variable 4 key for app container.'
    Type: String
    Default: ''
  AppEnvironment4Value:
    Description: 'Optional environment variable 4 value for app container.'
    Type: String
    Default: ''
  AppEnvironment5Key:
    Description: 'Optional environment variable 5 key for app container.'
    Type: String
    Default: ''
  AppEnvironment5Value:
    Description: 'Optional environment variable 5 value for app container.'
    Type: String
    Default: ''
  AppEnvironment6Key:
    Description: 'Optional environment variable 6 key for app container.'
    Type: String
    Default: ''
  AppEnvironment6Value:
    Description: 'Optional environment variable 6 value for app container.'
    Type: String
    Default: ''
  SidecarImage:
    Description: 'Optional Docker image to use for the sidecar container. You can use images in the Docker Hub registry or specify other repositories (repository-url/image:tag). If the repository is private, set SidecarImageSecretModule as well!'
    Type: String
    Default: ''
  SidecarImageSecretModule:
    Description: 'Optional stack name of secret module which contains the repository credentials for private registry authentication.'
    Type: String
    Default: ''
  SidecarPort:
    Description: 'The port exposed by the sidecar container reachable from the app container on host localhost (SidecarPort <> ProxyPort <> AppPort).'
    Type: Number
    Default: 9000
    MinValue: 1
    MaxValue: 49150
  SidecarEnvironment1Key:
    Description: 'Optional environment variable 1 key for sidecar container.'
    Type: String
    Default: ''
  SidecarEnvironment1Value:
    Description: 'Optional environment variable 1 value for sidecar container.'
    Type: String
    Default: ''
  SidecarEnvironment1SecretModule:
    Description: 'Optional environment variable 1 stack name of secret module for sidecar container (if SidecarEnvironment1Key is set, set either SidecarEnvironment1Value or SidecarEnvironment1SecretModule).'
    Type: String
    Default: ''
  SidecarEnvironment2Key:
    Description: 'Optional environment variable 2 key for sidecar container.'
    Type: String
    Default: ''
  SidecarEnvironment2Value:
    Description: 'Optional environment variable 2 value for sidecar container.'
    Type: String
    Default: ''
  SidecarEnvironment2SecretModule:
    Description: 'Optional environment variable 2 stack name of secret module for sidecar container (if SidecarEnvironment2Key is set, set either SidecarEnvironment2Value or SidecarEnvironment2SecretModule).'
    Type: String
    Default: ''
  SidecarEnvironment3Key:
    Description: 'Optional environment variable 3 key for sidecar container.'
    Type: String
    Default: ''
  SidecarEnvironment3Value:
    Description: 'Optional environment variable 3 value for sidecar container.'
    Type: String
    Default: ''
  SidecarEnvironment3SecretModule:
    Description: 'Optional environment variable 3 stack name of secret module for sidecar container (if SidecarEnvironment3Key is set, set either SidecarEnvironment3Value or SidecarEnvironment3SecretModule).'
    Type: String
    Default: ''
  Cpu:
    Description: 'The minimum number of vCPUs to reserve for the container.'
    Type: String
    Default: '0.25'
    AllowedValues: ['0.25', '0.5', '1', '2', '4']
  Memory:
    Description: 'The amount (in GB) of memory used by the task.'
    Type: String
    Default: '0.5'
    AllowedValues: ['0.5', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30']
  LogsRetentionInDays:
    Description: 'Specifies the number of days you want to retain log events in the specified log group.'
    Type: Number
    Default: 14
    AllowedValues: [1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, 3653]
  SubnetsReach:
    Description: 'Should the service have direct access to the Internet or do you prefer private subnets with NAT?'
    Type: String
    Default: Public
    AllowedValues:
    - Public
    - Private
  ScheduleExpression:
    Description: 'The schedule or rate (frequency) that determines when CloudWatch Events runs the rule (for valid values, see http://docs.aws.amazon.com/AmazonCloudWatch/latest/events/ScheduledEvents.html)'
    Type: String
    Default: 'rate(1 hour)'
  Timeout:
    Description: 'The timeout for a task execution in seconds.'
    Type: Number
    Default: 600 # 10 minutes
Mappings:
  CpuMap:
    '0.25':
      Cpu: 256
    '0.5':
      Cpu: 512
    '1':
      Cpu: 1024
    '2':
      Cpu: 2048
    '4':
      Cpu: 4096
  MemoryMap:
    '0.5':
      Memory: 512
    '1':
      Memory: 1024
    '2':
      Memory: 2048
    '3':
      Memory: 3072
    '4':
      Memory: 4096
    '5':
      Memory: 5120
    '6':
      Memory: 6144
    '7':
      Memory: 7168
    '8':
      Memory: 8192
    '9':
      Memory: 9216
    '10':
      Memory: 10240
    '11':
      Memory: 11264
    '12':
      Memory: 12288
    '13':
      Memory: 13312
    '14':
      Memory: 14336
    '15':
      Memory: 15360
    '16':
      Memory: 16384
    '17':
      Memory: 17408
    '18':
      Memory: 18432
    '19':
      Memory: 19456
    '20':
      Memory: 20480
    '21':
      Memory: 21504
    '22':
      Memory: 22528
    '23':
      Memory: 23552
    '24':
      Memory: 24576
    '25':
      Memory: 25600
    '26':
      Memory: 26624
    '27':
      Memory: 27648
    '28':
      Memory: 28672
    '29':
      Memory: 29696
    '30':
      Memory: 30720
Conditions:
  HasNotClusterModule: !Equals [!Ref ClusterModule, '']
  HasClusterModule: !Not [!Condition HasNotClusterModule]
  HasAlertingModule: !Not [!Equals [!Ref AlertingModule, '']]
  HasFileSystemModule1: !Not [!Equals [!Ref FileSystemModule1, '']]
  HasClientSgModule1: !Not [!Equals [!Ref ClientSgModule1, '']]
  HasClientSgModule2: !Not [!Equals [!Ref ClientSgModule2, '']]
  HasClientSgModule3: !Not [!Equals [!Ref ClientSgModule3, '']]
  HasSubnetsReachPublic: !Equals [!Ref SubnetsReach, Public]
  HasManagedPolicyArns: !Not [!Equals [!Ref ManagedPolicyArns, '']]
  HasAppCommand: !Not [!Equals [!Join ['', !Ref AppCommand], '']]
  HasAppEntryPoint: !Not [!Equals [!Join ['', !Ref AppEntryPoint], '']]
  HasAppImageSecretModule: !Not [!Equals [!Ref AppImageSecretModule, '']]
  HasAppEnvironment1PlainText: !And [!Not [!Equals [!Ref AppEnvironment1Key, '']], !Equals [!Ref AppEnvironment1SecretModule, '']]
  HasAppEnvironment2PlainText: !And [!Not [!Equals [!Ref AppEnvironment2Key, '']], !Equals [!Ref AppEnvironment2SecretModule, '']]
  HasAppEnvironment3PlainText: !And [!Not [!Equals [!Ref AppEnvironment3Key, '']], !Equals [!Ref AppEnvironment3SecretModule, '']]
  HasAppEnvironment4PlainText: !Not [!Equals [!Ref AppEnvironment4Key, '']]
  HasAppEnvironment5PlainText: !Not [!Equals [!Ref AppEnvironment5Key, '']]
  HasAppEnvironment6PlainText: !Not [!Equals [!Ref AppEnvironment6Key, '']]
  HasAppEnvironment1Secret: !And [!Not [!Equals [!Ref AppEnvironment1Key, '']], !Not [!Equals [!Ref AppEnvironment1SecretModule, '']]]
  HasAppEnvironment2Secret: !And [!Not [!Equals [!Ref AppEnvironment2Key, '']], !Not [!Equals [!Ref AppEnvironment2SecretModule, '']]]
  HasAppEnvironment3Secret: !And [!Not [!Equals [!Ref AppEnvironment3Key, '']], !Not [!Equals [!Ref AppEnvironment3SecretModule, '']]]
  HasSidecarImage: !Not [!Equals [!Ref SidecarImage, '']]
  HasSidecarImageSecretModule: !Not [!Equals [!Ref SidecarImageSecretModule, '']]
  HasSidecarEnvironment1PlainText: !And [!Not [!Equals [!Ref SidecarEnvironment1Key, '']], !Equals [!Ref SidecarEnvironment1SecretModule, '']]
  HasSidecarEnvironment2PlainText: !And [!Not [!Equals [!Ref SidecarEnvironment2Key, '']], !Equals [!Ref SidecarEnvironment2SecretModule, '']]
  HasSidecarEnvironment3PlainText: !And [!Not [!Equals [!Ref SidecarEnvironment3Key, '']], !Equals [!Ref SidecarEnvironment3SecretModule, '']]
  HasSidecarEnvironment1Secret: !And [!Not [!Equals [!Ref SidecarEnvironment1Key, '']], !Not [!Equals [!Ref SidecarEnvironment1SecretModule, '']]]
  HasSidecarEnvironment2Secret: !And [!Not [!Equals [!Ref SidecarEnvironment2Key, '']], !Not [!Equals [!Ref SidecarEnvironment2SecretModule, '']]]
  HasSidecarEnvironment3Secret: !And [!Not [!Equals [!Ref SidecarEnvironment3Key, '']], !Not [!Equals [!Ref SidecarEnvironment3SecretModule, '']]]
Resources:
  Cluster:
    Condition: HasNotClusterModule
    Type: 'AWS::ECS::Cluster'
    Properties: {}
  TaskExecutionRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: 'ecs-tasks.amazonaws.com'
          Action: 'sts:AssumeRole'
      Policies:
      - PolicyName: AmazonECSTaskExecutionRolePolicy # https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_execution_IAM_role.html
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action:
            - 'ecr:GetAuthorizationToken'
            - 'ecr:BatchCheckLayerAvailability'
            - 'ecr:GetDownloadUrlForLayer'
            - 'ecr:BatchGetImage'
            Resource: '*'
          - Effect: Allow
            Action:
            - 'logs:CreateLogStream'
            - 'logs:PutLogEvents'
            Resource: !GetAtt 'LogGroup.Arn'
          - Effect: Allow
            Action: 'kms:Decrypt'
            Resource: '*'
          - !If
            - HasAppImageSecretModule
            - Effect: Allow
              Action: 'secretsmanager:GetSecretValue'
              Resource: {'Fn::ImportValue': !Sub '${AppImageSecretModule}-Arn'}
            - !Ref 'AWS::NoValue'
          - !If
            - HasSidecarImageSecretModule
            - Effect: Allow
              Action: 'secretsmanager:GetSecretValue'
              Resource: {'Fn::ImportValue': !Sub '${SidecarImageSecretModule}-Arn'}
            - !Ref 'AWS::NoValue'
          - !If
            - HasAppEnvironment1Secret
            - Effect: Allow
              Action:
              - 'secretsmanager:GetSecretValue'
              Resource: {'Fn::ImportValue': !Sub '${AppEnvironment1SecretModule}-Arn'}
            - !Ref 'AWS::NoValue'
          - !If
            - HasAppEnvironment2Secret
            - Effect: Allow
              Action:
              - 'secretsmanager:GetSecretValue'
              Resource: {'Fn::ImportValue': !Sub '${AppEnvironment2SecretModule}-Arn'}
            - !Ref 'AWS::NoValue'
          - !If
            - HasAppEnvironment3Secret
            - Effect: Allow
              Action:
              - 'secretsmanager:GetSecretValue'
              Resource: {'Fn::ImportValue': !Sub '${AppEnvironment3SecretModule}-Arn'}
            - !Ref 'AWS::NoValue'
          - !If
            - HasSidecarEnvironment1Secret
            - Effect: Allow
              Action:
              - 'secretsmanager:GetSecretValue'
              Resource: {'Fn::ImportValue': !Sub '${SidecarEnvironment1SecretModule}-Arn'}
            - !Ref 'AWS::NoValue'
          - !If
            - HasSidecarEnvironment2Secret
            - Effect: Allow
              Action:
              - 'secretsmanager:GetSecretValue'
              Resource: {'Fn::ImportValue': !Sub '${SidecarEnvironment2SecretModule}-Arn'}
            - !Ref 'AWS::NoValue'
          - !If
            - HasSidecarEnvironment3Secret
            - Effect: Allow
              Action:
              - 'secretsmanager:GetSecretValue'
              Resource: {'Fn::ImportValue': !Sub '${SidecarEnvironment3SecretModule}-Arn'}
            - !Ref 'AWS::NoValue'
  TaskRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: 'ecs-tasks.amazonaws.com'
          Action: 'sts:AssumeRole'
      ManagedPolicyArns: !If [HasManagedPolicyArns, !Split [',', !Ref ManagedPolicyArns], !Ref 'AWS::NoValue']
  RuleRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: 'events.amazonaws.com'
          Action: 'sts:AssumeRole'
      Policies:
      - PolicyName: EventRulePolicy
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action: 'states:StartExecution'
            Resource: !Ref StateMachine
  TaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      ContainerDefinitions:
      - Name: app
        Image: !Ref AppImage
        RepositoryCredentials: !If [HasAppImageSecretModule, {CredentialsParameter: {'Fn::ImportValue': !Sub '${AppImageSecretModule}-Arn'}}, !Ref 'AWS::NoValue']
        Essential: true
        Command: !If [HasAppCommand, !Ref AppCommand, !Ref 'AWS::NoValue']
        EntryPoint: !If [HasAppEntryPoint, !Ref AppEntryPoint, !Ref 'AWS::NoValue']
        LogConfiguration:
          LogDriver: awslogs
          Options:
            'awslogs-region': !Ref 'AWS::Region'
            'awslogs-group': !Ref LogGroup
            'awslogs-stream-prefix': app
        Environment:
        - !If [HasAppEnvironment1PlainText, {Name: !Ref AppEnvironment1Key, Value: !Ref AppEnvironment1Value}, !Ref 'AWS::NoValue']
        - !If [HasAppEnvironment2PlainText, {Name: !Ref AppEnvironment2Key, Value: !Ref AppEnvironment2Value}, !Ref 'AWS::NoValue']
        - !If [HasAppEnvironment3PlainText, {Name: !Ref AppEnvironment3Key, Value: !Ref AppEnvironment3Value}, !Ref 'AWS::NoValue']
        - !If [HasAppEnvironment4PlainText, {Name: !Ref AppEnvironment4Key, Value: !Ref AppEnvironment4Value}, !Ref 'AWS::NoValue']
        - !If [HasAppEnvironment5PlainText, {Name: !Ref AppEnvironment5Key, Value: !Ref AppEnvironment5Value}, !Ref 'AWS::NoValue']
        - !If [HasAppEnvironment6PlainText, {Name: !Ref AppEnvironment6Key, Value: !Ref AppEnvironment6Value}, !Ref 'AWS::NoValue']
        Secrets:
        - !If [HasAppEnvironment1Secret, {Name: !Ref AppEnvironment1Key, ValueFrom: {'Fn::ImportValue': !Sub '${AppEnvironment1SecretModule}-Arn'}}, !Ref 'AWS::NoValue']
        - !If [HasAppEnvironment2Secret, {Name: !Ref AppEnvironment2Key, ValueFrom: {'Fn::ImportValue': !Sub '${AppEnvironment2SecretModule}-Arn'}}, !Ref 'AWS::NoValue']
        - !If [HasAppEnvironment3Secret, {Name: !Ref AppEnvironment3Key, ValueFrom: {'Fn::ImportValue': !Sub '${AppEnvironment3SecretModule}-Arn'}}, !Ref 'AWS::NoValue']
        MountPoints:
        - !If [HasFileSystemModule1, {ContainerPath: '/mnt/efs1', SourceVolume: efs1}, !Ref 'AWS::NoValue']
      - !If
        - HasSidecarImage
        - Name: sidecar
          Image: !Ref SidecarImage
          RepositoryCredentials: !If [HasSidecarImageSecretModule, {CredentialsParameter: {'Fn::ImportValue': !Sub '${SidecarImageSecretModule}-Arn'}}, !Ref 'AWS::NoValue']
          PortMappings:
          - ContainerPort: !Ref SidecarPort
            Protocol: tcp
          Essential: false
          LogConfiguration:
            LogDriver: awslogs
            Options:
              'awslogs-region': !Ref 'AWS::Region'
              'awslogs-group': !Ref LogGroup
              'awslogs-stream-prefix': sidecar
          Environment:
          - !If [HasSidecarEnvironment1PlainText, {Name: !Ref SidecarEnvironment1Key, Value: !Ref SidecarEnvironment1Value}, !Ref 'AWS::NoValue']
          - !If [HasSidecarEnvironment2PlainText, {Name: !Ref SidecarEnvironment2Key, Value: !Ref SidecarEnvironment2Value}, !Ref 'AWS::NoValue']
          - !If [HasSidecarEnvironment3PlainText, {Name: !Ref SidecarEnvironment3Key, Value: !Ref SidecarEnvironment3Value}, !Ref 'AWS::NoValue']
          Secrets:
          - !If [HasSidecarEnvironment1Secret, {Name: !Ref SidecarEnvironment1Key, ValueFrom: {'Fn::ImportValue': !Sub '${SidecarEnvironment1SecretModule}-Arn'}}, !Ref 'AWS::NoValue']
          - !If [HasSidecarEnvironment2Secret, {Name: !Ref SidecarEnvironment2Key, ValueFrom: {'Fn::ImportValue': !Sub '${SidecarEnvironment2SecretModule}-Arn'}}, !Ref 'AWS::NoValue']
          - !If [HasSidecarEnvironment3Secret, {Name: !Ref SidecarEnvironment3Key, ValueFrom: {'Fn::ImportValue': !Sub '${SidecarEnvironment3SecretModule}-Arn'}}, !Ref 'AWS::NoValue']
          MountPoints:
          - !If [HasFileSystemModule1, {ContainerPath: '/mnt/efs1', SourceVolume: efs1}, !Ref 'AWS::NoValue']
        - !Ref 'AWS::NoValue'
      Cpu: !FindInMap [CpuMap, !Ref Cpu, Cpu]
      ExecutionRoleArn: !GetAtt 'TaskExecutionRole.Arn'
      Family: !Ref 'AWS::StackName'
      Memory: !FindInMap [MemoryMap, !Ref Memory, Memory]
      NetworkMode: awsvpc
      RequiresCompatibilities: [FARGATE]
      TaskRoleArn: !GetAtt 'TaskRole.Arn'
      Volumes:
      - !If [HasFileSystemModule1, {EFSVolumeConfiguration: {FilesystemId: {'Fn::ImportValue': !Sub '${FileSystemModule1}-Id'}, TransitEncryption: ENABLED}, Name: efs1}, !Ref 'AWS::NoValue']
  LogGroup:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      RetentionInDays: !Ref LogsRetentionInDays
  Rule:
    Type: 'AWS::Events::Rule'
    Properties:
      ScheduleExpression: !Ref ScheduleExpression
      State: ENABLED
      Targets:
      - Arn: !Ref StateMachine
        Id: statemachine
        RoleArn: !GetAtt 'RuleRole.Arn'
  StateMachineRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: 'states.amazonaws.com'
          Action: 'sts:AssumeRole'
      Policies:
      - PolicyName: StateMachine
        PolicyDocument:
          Statement:
          - Effect: Allow
            Action: 'iam:PassRole'
            Resource:
            - !GetAtt TaskExecutionRole.Arn
            - !GetAtt TaskRole.Arn
          - Effect: Allow
            Action: 'ecs:RunTask'
            Resource: !Ref TaskDefinition
            Condition:
              ArnEquals:
                'ecs:cluster': !If [HasClusterModule, {'Fn::ImportValue': !Sub '${ClusterModule}-Arn'}, !GetAtt Cluster.Arn]
          - Effect: Allow
            Action:
            - 'ecs:StopTask'
            - 'ecs:DescribeTasks'
            Resource: '*'
            Condition:
              ArnEquals:
                'ecs:cluster': !If [HasClusterModule, {'Fn::ImportValue': !Sub '${ClusterModule}-Arn'}, !GetAtt Cluster.Arn]
          - Effect: Allow
            Action:
            - 'events:PutTargets'
            - 'events:PutRule'
            - 'events:DescribeRule'
            Resource: !Sub 'arn:${AWS::Partition}:events:${AWS::Region}:${AWS::AccountId}:rule/StepFunctionsGetEventsForECSTaskRule'
  StateMachine:
    Type: 'AWS::StepFunctions::StateMachine'
    Properties:
      DefinitionString: !Sub
      - |
        {
          "Version": "1.0",
          "Comment": "Run ECS/Fargate tasks",
          "TimeoutSeconds": ${Timeout},
          "StartAt": "RunTask",
          "States": {
            "RunTask": {
              "Type": "Task",
              "Resource": "arn:aws:states:::ecs:runTask.sync",
              "Parameters": {
                "LaunchType": "FARGATE",
                "Cluster": "${Cluster}",
                "TaskDefinition": "${TaskDefinition}",
                "NetworkConfiguration": {
                  "AwsvpcConfiguration": {
                    "Subnets": ["${SubnetA}", "${SubnetB}"],
                    "AssignPublicIp": "${AssignPublicIp}",
                    "SecurityGroups": ${SecurityGroups}
                  }
                }
              },
              "Retry": [
                {
                  "ErrorEquals": [
                    "States.TaskFailed"
                  ],
                  "IntervalSeconds": 10,
                  "MaxAttempts": 3,
                  "BackoffRate": 2
                }
              ],
              "End": true
            }
          }
        }
      - Cluster: !If [HasClusterModule, {'Fn::ImportValue': !Sub '${ClusterModule}-Arn'}, !GetAtt Cluster.Arn]
        TaskDefinition: !Ref TaskDefinition
        SubnetA: {'Fn::ImportValue': !Sub '${VpcModule}-SubnetIdA${SubnetsReach}'}
        SubnetB: {'Fn::ImportValue': !Sub '${VpcModule}-SubnetIdB${SubnetsReach}'}
        AssignPublicIp: !If [HasSubnetsReachPublic, ENABLED, DISABLED]
        SecurityGroups: !Join ['', ['["', !Join ['","', [!Ref SecurityGroup, !If [HasClientSgModule1, {'Fn::ImportValue': !Sub '${ClientSgModule1}-SecurityGroupId'}, !Ref AWS::NoValue], !If [HasClientSgModule2, {'Fn::ImportValue': !Sub '${ClientSgModule2}-SecurityGroupId'}, !Ref AWS::NoValue], !If [HasClientSgModule3, {'Fn::ImportValue': !Sub '${ClientSgModule3}-SecurityGroupId'}, !Ref AWS::NoValue]]], '"]']]
        Timeout: !Ref Timeout
      RoleArn: !GetAtt 'StateMachineRole.Arn'
  SecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: !Ref 'AWS::StackName'
      VpcId: {'Fn::ImportValue': !Sub '${VpcModule}-Id'}
  ExecutionsFailedAlarm:
    Condition: HasAlertingModule
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: 'Failure while executing scheduled task.'
      Namespace: 'AWS/States'
      MetricName: ExecutionsFailed
      Dimensions:
      - Name: StateMachineArn
        Value: !Ref StateMachine
      Statistic: Sum
      Period: 300
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Threshold: 0
      TreatMissingData: notBreaching
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
      - {'Fn::ImportValue': !Sub '${AlertingModule}-Arn'}
  ExecutionsTimeoutAlarm:
    Condition: HasAlertingModule
    Type: 'AWS::CloudWatch::Alarm'
    Properties:
      AlarmDescription: 'Executing scheduled task timed out.'
      Namespace: 'AWS/States'
      MetricName: ExecutionsTimedOut
      Dimensions:
      - Name: StateMachineArn
        Value: !Ref StateMachine
      Statistic: Sum
      Period: 300
      DatapointsToAlarm: 1
      EvaluationPeriods: 1
      Threshold: 0
      TreatMissingData: notBreaching
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
      - {'Fn::ImportValue': !Sub '${AlertingModule}-Arn'}
Outputs:
  ModuleId:
    Value: 'fargate-scheduled-task'
  ModuleVersion:
    Value: '1.4.0'
  StackName:
    Value: !Ref 'AWS::StackName'
  TaskRoleArn:
    Value: !GetAtt 'TaskRole.Arn'
    Export:
      Name: !Sub '${AWS::StackName}-TaskRoleArn'
